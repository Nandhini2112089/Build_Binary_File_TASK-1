pipeline {
    agent any

    environment {
        APP_IMAGE = "password-checker-app"
        CONTAINER_NAME = "password-checker-container"
        PORT = "8091"
    }

    stages {

        stage('Clone Repo') {
            steps {
                checkout scm
            }
        }

        stage('Build Binary') {
            steps {
                dir('JENKINS_PIPELINE') {
                    sh '''
                        chmod +x build.sh
                        ./build.sh
                    '''
                }
            }
        }

        stage('Build Docker Image') {
            steps {
                dir('JENKINS_PIPELINE') {
                    sh '''
                        docker build -t $APP_IMAGE .
                    '''
                }
            }
        }

        stage('Run Docker Container') {
            steps {
                sh '''
                    docker rm -f $CONTAINER_NAME || true
                    docker run -d -p ${PORT}:8081 --name $CONTAINER_NAME $APP_IMAGE
                '''
            }
        }
    }

    post {
        always {
            echo "Pipeline finished!"
        }
    }
}
